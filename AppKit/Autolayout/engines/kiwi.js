
/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2018, Nucleic Development Team & H. Rutjes.
|
| Distributed under the terms of the Modified BSD License.
|
| The full license is in the file COPYING.txt, distributed with this software.
-----------------------------------------------------------------------------*/

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.kiwi={})}(this,function(_){"use strict";function l(t){return new e}var e=function(){function i(){this.index={},this.array=[]}return i.prototype.size=function(){return this.array.length},i.prototype.empty=function(){return 0===this.array.length},i.prototype.itemAt=function(t){return this.array[t]},i.prototype.contains=function(t){return void 0!==this.index[t.id()]},i.prototype.find=function(t){var e=this.index[t.id()];return void 0===e?void 0:this.array[e]},i.prototype.setDefault=function(t,e){var r=this.index[t.id()];if(void 0!==r)return this.array[r];var i=new n(t,e());return this.index[t.id()]=this.array.length,this.array.push(i),i},i.prototype.insert=function(t,e){var r=new n(t,e),i=this.index[t.id()];return void 0===i?(this.index[t.id()]=this.array.length,this.array.push(r)):this.array[i]=r,r},i.prototype.erase=function(t){var e=this.index[t.id()];if(void 0!==e){this.index[t.id()]=void 0;var r=this.array[e],i=this.array.pop();return r!==i&&(this.array[e]=i,this.index[i.first.id()]=e),r}},i.prototype.copy=function(){for(var t=new i,e=0;e<this.array.length;e++){var r=this.array[e].copy();t.array[e]=r,t.index[r.first.id()]=e}return t},i}(),n=function(){function t(t,e){this.first=t,this.second=e}return t.prototype.copy=function(){return new t(this.first,this.second)},t}(),d=function(){function t(t){void 0===t&&(t=""),this._value=0,this._context=null,this._onsolved=null,this._id=r++,this._name=t}return t.Compare=function(t,e){return t.id()-e.id()},t.prototype.id=function(){return this._id},t.prototype.name=function(){return this._name},t.prototype.setName=function(t){this._name=t},t.prototype.context=function(){return this._context},t.prototype.setContext=function(t){this._context=t},t.prototype.value=function(){return this._value},t.prototype.setValue=function(t,e){void 0===e&&(e=!1),t!==this._value&&(this._value=t,e&&this._onsolved&&this._onsolved(this))},t.prototype.setOnSolved=function(t){this._onsolved=t},t.prototype.plus=function(t){return new v(this,t)},t.prototype.minus=function(t){return new v(this,"number"==typeof t?-t:[-1,t])},t.prototype.multiply=function(t){return new v([t,this])},t.prototype.divide=function(t){return new v([1/t,this])},t.prototype.toJSON=function(){return{name:this._name,value:this._value}},t.prototype.toString=function(){return this._context+"["+this._name+":"+this._value+"]"},t}(),r=0,v=function(){function e(){var t=function(t){for(var e=0,r=function(){return 0},i=l(d.Compare),n=0,o=t.length;n<o;++n){var s=t[n];if("number"==typeof s)e+=s;else if(s instanceof d)i.setDefault(s,r).second+=1;else if(s instanceof v){e+=s.constant();for(var a=s.terms(),c=0,p=a.size();c<p;c++){var u=a.itemAt(c);i.setDefault(u.first,r).second+=u.second}}else{if(!(s instanceof Array))throw new Error("invalid Expression argument: "+s);if(2!==s.length)throw new Error("array must have length 2");var f=s[0],h=s[1];if("number"!=typeof f)throw new Error("array item 0 must be a number");if(h instanceof d)i.setDefault(h,r).second+=f;else{if(!(h instanceof v))throw new Error("array item 1 must be a variable or expression");e+=h.constant()*f;for(var a=h.terms(),c=0,p=a.size();c<p;c++){var u=a.itemAt(c);i.setDefault(u.first,r).second+=u.second*f}}}}return{terms:i,constant:e}}(arguments);this._terms=t.terms,this._constant=t.constant}return e.prototype.terms=function(){return this._terms},e.prototype.constant=function(){return this._constant},e.prototype.value=function(){for(var t=this._constant,e=0,r=this._terms.size();e<r;e++){var i=this._terms.itemAt(e);t+=i.first.value()*i.second}return t},e.prototype.plus=function(t){return new e(this,t)},e.prototype.minus=function(t){return new e(this,"number"==typeof t?-t:[-1,t])},e.prototype.multiply=function(t){return new e([t,this])},e.prototype.divide=function(t){return new e([1/t,this])},e.prototype.isConstant=function(){return 0==this._terms.size()},e.prototype.toString=function(){var t=this._terms.array.map(function(t,e){var r="",i=t.second;return 0!==i&&(1!==i&&(r+=i+"*"),r+=t.first.toString()),r}).join(" + "),e=this._constant;return 0!==e&&(this.isConstant()?t+=e:t+=(e<0?" - ":" + ")+Math.abs(e)),t},e}();var t,b=function(){function e(){}return e.create=function(t,e,r,i,n,o,s){void 0===s&&(s=1);var a=0;return a+=Math.max(0,Math.min(1e3,t*s))*Math.pow(10,15),a+=Math.max(0,Math.min(1e3,e*s))*Math.pow(10,12),a+=Math.max(0,Math.min(1e3,r*s))*Math.pow(10,9),a+=Math.max(0,Math.min(1e3,i*s))*Math.pow(10,6),a+=Math.max(0,Math.min(1e3,n*s))*Math.pow(10,3),a+=Math.max(0,Math.min(1e3,o*s))},e.clip=function(t){return Math.max(0,Math.min(e.required,t))},e.required=e.create(1e3,1e3,1e3,1e3,1e3,1e3),e.strong=e.create(0,0,0,1,0,0),e.medium=e.create(0,0,0,0,1,0),e.weak=e.create(0,0,0,0,0,1),e}();(t=_.Operator||(_.Operator={}))[t.Le=0]="Le",t[t.Ge=1]="Ge",t[t.Eq=2]="Eq";var w,i,o=function(){function t(t,e,r,i){void 0===i&&(i=b.required),this._id=s++,this._operator=e,this._strength=b.clip(i),this._expression=void 0===r&&t instanceof v?t:t.minus(r)}return t.Compare=function(t,e){return t.id()-e.id()},t.prototype.id=function(){return this._id},t.prototype.expression=function(){return this._expression},t.prototype.op=function(){return this._operator},t.prototype.strength=function(){return this._strength},t.prototype.toString=function(){return this._expression.toString()+" "+["<=",">=","="][this._operator]+" 0 ("+this._strength.toString()+")"},t}(),s=0,a=function(){function t(){this._cnMap=l(o.Compare),this._rowMap=l(c.Compare),this._varMap=l(d.Compare),this._editMap=l(d.Compare),this._infeasibleRows=[],this._objective=new S,this._artificial=null,this._idTick=0}return t.prototype.createConstraint=function(t,e,r,i){void 0===i&&(i=b.required);var n=new o(t,e,r,i);return this.addConstraint(n),n},t.prototype.addConstraint=function(t){if(void 0!==this._cnMap.find(t))throw new Error("duplicate constraint");var e=this._createRow(t),r=e.row,i=e.tag,n=this._chooseSubject(r,i);if(n.type()===w.Invalid&&r.allDummies()){if(!M(r.constant()))throw new Error("unsatisfiable constraint");n=i.marker}if(n.type()===w.Invalid){if(!this._addWithArtificialVariable(r))throw new Error("unsatisfiable constraint")}else r.solveFor(n),this._substitute(n,r),this._rowMap.insert(n,r);this._cnMap.insert(t,i),this._optimize(this._objective)},t.prototype.removeConstraint=function(t){var e=this._cnMap.erase(t);if(void 0===e)throw new Error("unknown constraint");this._removeConstraintEffects(t,e.second);var r=e.second.marker,i=this._rowMap.erase(r);if(void 0===i){var n=this._getMarkerLeavingSymbol(r);if(n.type()===w.Invalid)throw new Error("failed to find leaving row");(i=this._rowMap.erase(n)).second.solveForEx(n,r),this._substitute(r,i.second)}this._optimize(this._objective)},t.prototype.hasConstraint=function(t){return this._cnMap.contains(t)},t.prototype.addEditVariable=function(t,e){if(void 0!==this._editMap.find(t))throw new Error("duplicate edit variable");if((e=b.clip(e))===b.required)throw new Error("bad required strength");var r=new v(t),i=new o(r,_.Operator.Eq,void 0,e);this.addConstraint(i);var n={tag:this._cnMap.find(i).second,constraint:i,constant:0};this._editMap.insert(t,n)},t.prototype.removeEditVariable=function(t){var e=this._editMap.erase(t);if(void 0===e)throw new Error("unknown edit variable");this.removeConstraint(e.second.constraint)},t.prototype.hasEditVariable=function(t){return this._editMap.contains(t)},t.prototype.suggestValue=function(t,e){var r=this._editMap.find(t);if(void 0===r)throw new Error("unknown edit variable");var i=this._rowMap,n=r.second,o=e-n.constant;n.constant=e;var s=n.tag.marker,a=i.find(s);if(void 0!==a)return a.second.add(-o)<0&&this._infeasibleRows.push(s),void this._dualOptimize();var c=n.tag.other;if(void 0!==(a=i.find(c)))return a.second.add(o)<0&&this._infeasibleRows.push(c),void this._dualOptimize();for(var p=0,u=i.size();p<u;++p){var f=i.itemAt(p),h=f.second,l=h.coefficientFor(s);0!==l&&h.add(o*l)<0&&f.first.type()!==w.External&&this._infeasibleRows.push(f.first)}this._dualOptimize()},t.prototype.updateVariables=function(){for(var t=this._varMap,e=this._rowMap,r=0,i=t.size();r<i;++r){var n=t.itemAt(r),o=e.find(n.second);void 0!==o?n.first.setValue(o.second.constant(),!0):n.first.setValue(0,!0)}},t.prototype._getVarSymbol=function(t){var e=this;return this._varMap.setDefault(t,function(){return e._makeSymbol(w.External)}).second},t.prototype._createRow=function(t){for(var e=t.expression(),r=new S(e.constant()),i=e.terms(),n=0,o=i.size();n<o;++n){var s=i.itemAt(n);if(!M(s.second)){var a=this._getVarSymbol(s.first),c=this._rowMap.find(a);void 0!==c?r.insertRow(c.second,s.second):r.insertSymbol(a,s.second)}}var p=this._objective,u=t.strength(),f={marker:E,other:E};switch(t.op()){case _.Operator.Le:case _.Operator.Ge:var h=t.op()===_.Operator.Le?1:-1,l=this._makeSymbol(w.Slack);if(f.marker=l,r.insertSymbol(l,h),u<b.required){var d=this._makeSymbol(w.Error);f.other=d,r.insertSymbol(d,-h),p.insertSymbol(d,u)}break;case _.Operator.Eq:if(u<b.required){var v=this._makeSymbol(w.Error),y=this._makeSymbol(w.Error);f.marker=v,f.other=y,r.insertSymbol(v,-1),r.insertSymbol(y,1),p.insertSymbol(v,u),p.insertSymbol(y,u)}else{var m=this._makeSymbol(w.Dummy);f.marker=m,r.insertSymbol(m)}}return r.constant()<0&&r.reverseSign(),{row:r,tag:f}},t.prototype._chooseSubject=function(t,e){for(var r=t.cells(),i=0,n=r.size();i<n;++i){var o=r.itemAt(i);if(o.first.type()===w.External)return o.first}var s=e.marker.type();return(s===w.Slack||s===w.Error)&&t.coefficientFor(e.marker)<0?e.marker:((s=e.other.type())===w.Slack||s===w.Error)&&t.coefficientFor(e.other)<0?e.other:E},t.prototype._addWithArtificialVariable=function(t){var e=this._makeSymbol(w.Slack);this._rowMap.insert(e,t.copy()),this._artificial=t.copy(),this._optimize(this._artificial);var r=M(this._artificial.constant());this._artificial=null;var i=this._rowMap.erase(e);if(void 0!==i){var n=i.second;if(n.isConstant())return r;var o=this._anyPivotableSymbol(n);if(o.type()===w.Invalid)return!1;n.solveForEx(e,o),this._substitute(o,n),this._rowMap.insert(o,n)}for(var s=this._rowMap,a=0,c=s.size();a<c;++a)s.itemAt(a).second.removeSymbol(e);return this._objective.removeSymbol(e),r},t.prototype._substitute=function(t,e){for(var r=this._rowMap,i=0,n=r.size();i<n;++i){var o=r.itemAt(i);o.second.substitute(t,e),o.second.constant()<0&&o.first.type()!==w.External&&this._infeasibleRows.push(o.first)}this._objective.substitute(t,e),this._artificial&&this._artificial.substitute(t,e)},t.prototype._optimize=function(t){for(;;){var e=this._getEnteringSymbol(t);if(e.type()===w.Invalid)return;var r=this._getLeavingSymbol(e);if(r.type()===w.Invalid)throw new Error("the objective is unbounded");var i=this._rowMap.erase(r).second;i.solveForEx(r,e),this._substitute(e,i),this._rowMap.insert(e,i)}},t.prototype._dualOptimize=function(){for(var t=this._rowMap,e=this._infeasibleRows;0!==e.length;){var r=e.pop(),i=t.find(r);if(void 0!==i&&i.second.constant()<0){var n=this._getDualEnteringSymbol(i.second);if(n.type()===w.Invalid)throw new Error("dual optimize failed");var o=i.second;t.erase(r),o.solveForEx(r,n),this._substitute(n,o),t.insert(n,o)}}},t.prototype._getEnteringSymbol=function(t){for(var e=t.cells(),r=0,i=e.size();r<i;++r){var n=e.itemAt(r),o=n.first;if(n.second<0&&o.type()!==w.Dummy)return o}return E},t.prototype._getDualEnteringSymbol=function(t){for(var e=Number.MAX_VALUE,r=E,i=t.cells(),n=0,o=i.size();n<o;++n){var s=i.itemAt(n),a=s.first,c=s.second;if(0<c&&a.type()!==w.Dummy){var p=this._objective.coefficientFor(a)/c;p<e&&(e=p,r=a)}}return r},t.prototype._getLeavingSymbol=function(t){for(var e=Number.MAX_VALUE,r=E,i=this._rowMap,n=0,o=i.size();n<o;++n){var s=i.itemAt(n),a=s.first;if(a.type()!==w.External){var c=s.second,p=c.coefficientFor(t);if(p<0){var u=-c.constant()/p;u<e&&(e=u,r=a)}}}return r},t.prototype._getMarkerLeavingSymbol=function(t){for(var e=Number.MAX_VALUE,r=e,i=e,n=E,o=n,s=n,a=n,c=this._rowMap,p=0,u=c.size();p<u;++p){var f=c.itemAt(p),h=f.second,l=h.coefficientFor(t);if(0!==l){var d=f.first;if(d.type()===w.External)a=d;else if(l<0){(v=-h.constant()/l)<r&&(r=v,o=d)}else{var v;(v=h.constant()/l)<i&&(i=v,s=d)}}}return o!==n?o:s!==n?s:a},t.prototype._removeConstraintEffects=function(t,e){e.marker.type()===w.Error&&this._removeMarkerEffects(e.marker,t.strength()),e.other.type()===w.Error&&this._removeMarkerEffects(e.other,t.strength())},t.prototype._removeMarkerEffects=function(t,e){var r=this._rowMap.find(t);void 0!==r?this._objective.insertRow(r.second,-e):this._objective.insertSymbol(t,-e)},t.prototype._anyPivotableSymbol=function(t){for(var e=t.cells(),r=0,i=e.size();r<i;++r){var n=e.itemAt(r),o=n.first.type();if(o===w.Slack||o===w.Error)return n.first}return E},t.prototype._makeSymbol=function(t){return new c(t,this._idTick++)},t}();function M(t){return t<0?-t<1e-8:t<1e-8}(i=w||(w={}))[i.Invalid=0]="Invalid",i[i.External=1]="External",i[i.Slack=2]="Slack",i[i.Error=3]="Error",i[i.Dummy=4]="Dummy";var c=function(){function t(t,e){this._id=e,this._type=t}return t.Compare=function(t,e){return t.id()-e.id()},t.prototype.id=function(){return this._id},t.prototype.type=function(){return this._type},t}(),E=new c(w.Invalid,-1),S=function(){function e(t){void 0===t&&(t=0),this._cellMap=l(c.Compare),this._constant=t}return e.prototype.cells=function(){return this._cellMap},e.prototype.constant=function(){return this._constant},e.prototype.isConstant=function(){return this._cellMap.empty()},e.prototype.allDummies=function(){for(var t=this._cellMap,e=0,r=t.size();e<r;++e){if(t.itemAt(e).first.type()!==w.Dummy)return!1}return!0},e.prototype.copy=function(){var t=new e(this._constant);return t._cellMap=this._cellMap.copy(),t},e.prototype.add=function(t){return this._constant+=t},e.prototype.insertSymbol=function(t,e){void 0===e&&(e=1),M(this._cellMap.setDefault(t,function(){return 0}).second+=e)&&this._cellMap.erase(t)},e.prototype.insertRow=function(t,e){void 0===e&&(e=1),this._constant+=t._constant*e;for(var r=t._cellMap,i=0,n=r.size();i<n;++i){var o=r.itemAt(i);this.insertSymbol(o.first,o.second*e)}},e.prototype.removeSymbol=function(t){this._cellMap.erase(t)},e.prototype.reverseSign=function(){this._constant=-this._constant;for(var t=this._cellMap,e=0,r=t.size();e<r;++e){var i=t.itemAt(e);i.second=-i.second}},e.prototype.solveFor=function(t){var e=this._cellMap,r=-1/e.erase(t).second;this._constant*=r;for(var i=0,n=e.size();i<n;++i)e.itemAt(i).second*=r},e.prototype.solveForEx=function(t,e){this.insertSymbol(t,-1),this.solveFor(e)},e.prototype.coefficientFor=function(t){var e=this._cellMap.find(t);return void 0!==e?e.second:0},e.prototype.substitute=function(t,e){var r=this._cellMap.erase(t);void 0!==r&&this.insertRow(e,r.second)},e}();_.Constraint=o,_.Expression=v,_.Solver=a,_.Strength=b,_.Variable=d,Object.defineProperty(_,"__esModule",{value:!0})});
